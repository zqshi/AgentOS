# 项目执行规范与目录结构（DDD/TDD）

**版本**：V1.0  
**适用范围**：AgentOS 全局唯一执行规范，所有产品方向统一遵循  
**最后更新**：2026-01-08

---

## 1. 目标与原则

- **DDD 作为设计范式**：以领域模型驱动设计，拆分边界上下文（Bounded Context），降低耦合。
- **TDD 作为开发要求**：先写测试再写实现，确保可验证、可演进、可回归。
- **产品方向独立维护**：每个产品方向（灵枢/无影/智核）独立代码目录，独立测试、构建、发布。
- **全局规范唯一**：本规范在全仓库内唯一生效，所有新增模块必须遵循。

---

## 2. DDD 执行规范

### 2.1 领域分层（强制）

每个产品方向内必须采用四层结构（可按语言习惯命名，但含义一致）：

- **domain**：领域模型（实体、值对象、聚合、领域服务、领域事件）
- **application**：应用服务（用例编排、事务边界、DTO）
- **infrastructure**：基础设施（持久化、外部系统适配、消息、缓存）
- **interfaces/presentation**：接口层（HTTP/RPC/CLI/UI）

### 2.2 约束规则（强制）

- **依赖方向固定**：interfaces → application → domain；infrastructure 仅被 application 调用。
- **领域层不可依赖外部技术**（数据库、HTTP、MQ 等）。
- **聚合是事务一致性边界**，跨聚合通过领域事件协作。
- **Bounded Context 以产品模块拆分**，禁止跨产品方向直接引用 domain。

---

## 3. TDD 执行规范

### 3.1 基本流程

1. **Red**：根据用户故事/验收标准先写失败测试。
2. **Green**：最小实现通过测试。
3. **Refactor**：重构代码与测试，保持测试通过。

### 3.2 测试层级

- **单元测试**：覆盖 domain 和 application 的核心逻辑。
- **集成测试**：覆盖 infrastructure 与外部依赖。
- **端到端测试**：覆盖关键用户路径。

### 3.3 质量门禁（建议起点）

- 单元测试覆盖率 ≥ 70%
- 关键业务路径必须有端到端测试
- 新增功能必须包含：正常路径 + 异常路径测试

---

## 4. 目录结构（全局标准）

### 4.1 根目录

```
AgentOS/
├── README.md
├── docs/                          # 全局规范与公共文档
├── 00-战略与规划/
├── 灵枢/                          # 产品方向：后台智能中枢
├── 无影/                          # 产品方向：中台集成赋能
├── 智核/                          # 产品方向：前台智能工作台
└── shared/                        # 跨产品共享库（严格控制依赖）
```

### 4.2 产品方向目录（每个产品独立维护）

```
产品方向/
├── docs/                          # 本产品的需求、设计、验收
├── apps/                          # 可执行应用（Web/Service/Worker）
│   └── <app-name>/
│       ├── src/
│       │   ├── domain/
│       │   ├── application/
│       │   ├── infrastructure/
│       │   └── interfaces/
│       ├── tests/
│       └── README.md
├── packages/                      # 可复用模块（仅本产品内复用）
└── scripts/                       # 构建、测试、发布脚本
```

### 4.3 shared 约束（强制）

- 仅放**跨产品通用**能力（如基础工具库、通用类型定义）。
- shared **不能依赖任何产品方向**。
- 产品方向只能通过版本化依赖 shared，禁止源码级互相引用。

---

## 5. 工程执行规范（强制）

### 5.1 分支与提交

- 主干保护：`main` 仅允许合并，禁止直接提交。
- 分支命名：`feat/`、`fix/`、`chore/`、`test/` 前缀。
- 提交信息：必须包含清晰意图与范围（如 `feat(knowledge-graph): add snapshot api`）。

### 5.2 代码评审

- 任何业务代码必须经过评审后合并。
- 评审关注点：领域边界、依赖方向、测试覆盖、回归风险。

### 5.3 CI 门禁

- 必须通过：单元测试、静态检查、构建检查。
- 未通过门禁禁止合并。

### 5.4 测试策略

- 变更必须包含对应测试（单测或集成测）。
- 关键链路新增必须补端到端用例。
- 回归缺陷必须先补测试再修复。

### 5.5 版本与发布

- 版本号遵循语义化（SemVer）。
- 破坏性变更必须提供迁移说明与回滚方案。

### 5.6 依赖与安全

- 新增三方依赖需登记用途与风险评估。
- 安全与合规问题必须在合入前修复或降级处理。

### 5.7 文档与可追溯性

- 需求变更必须同步更新 `docs/` 与验收标准。
- 代码与文档需互相引用，保持可追溯。

---

## 6. 交付与执行要求（强制）

- **每个产品方向独立构建与测试**，CI 可按目录触发。
- **新增模块必须归属某一产品方向**，禁止“跨产品混放”。
- **测试与代码同生命周期**，禁止先写代码后补测试。
- **需求变更必须更新对应 tests 与 docs**。

---

## 7. 落地检查清单（每次迭代）

- [ ] 新增代码是否在正确产品目录下？
- [ ] 是否满足 DDD 分层与依赖规则？
- [ ] 是否先写测试并通过？
- [ ] 是否更新对应文档与验收标准？
