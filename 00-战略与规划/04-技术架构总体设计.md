# AgentOS 技术架构总体设计

**版本**：V1.0
**状态**：设计中（Draft）
**最后更新**：2026-01-08
**负责人**：技术架构组

---

## 文档摘要

本文档定义了AgentOS企业智能中枢产品矩阵的技术架构蓝图，包括系统架构、技术选型、部署方案、数据流设计等核心内容。本架构遵循"高内聚、低耦合、可扩展、可演进"的设计原则，支持私有化部署和云端SaaS两种交付模式。

**关键决策**：
- 采用微服务架构，支持模块独立演进
- 图数据库选用Neo4j Enterprise（性能与生态平衡）
- 向量数据库选用Milvus（开源、高性能）
- 核心服务使用Python（AI能力）+ Go（高性能API）
- 容器化部署，支持Kubernetes编排

---

## 一、架构设计原则

### 1.1 核心设计原则

| 原则 | 说明 | 实践方式 |
|------|------|---------|
| **高内聚低耦合** | 模块职责单一，接口清晰 | 微服务架构，通过API网关统一访问 |
| **可扩展性** | 支持水平扩展和垂直扩展 | 无状态服务设计，数据分片存储 |
| **可观测性** | 全链路追踪，快速定位问题 | 集成Prometheus/Grafana/Jaeger |
| **安全第一** | 零信任架构，最小权限原则 | RBAC+ABAC权限模型，数据加密 |
| **可演进性** | 支持技术栈平滑升级 | 版本化API，兼容性测试 |

### 1.2 架构约束与假设

**约束条件**：
1. 支持私有化部署（客户自有机房/云环境）
2. 支持云端SaaS多租户模式
3. 单租户数据规模：10亿级三元组（不追求万亿级，务实定位）
4. 并发用户数：单租户1000+，SaaS模式10000+
5. 核心API响应时间：P95 < 200ms，P99 < 500ms

**技术假设**：
1. 目标客户有基础的容器化运维能力
2. 网络环境支持HTTPS/gRPC通信
3. 数据中心具备冗余电力和网络
4. 可使用外部大模型API（OpenAI/Claude/国产）

---

## 二、系统架构设计（C4 Model）

### 2.1 Context视图：系统上下文

```
                         ┌─────────────────────────┐
                         │   企业用户生态           │
                         │  (知识工作者/管理员)      │
                         └────────────┬────────────┘
                                      │
                  ┌───────────────────┼───────────────────┐
                  │                   │                   │
                  ▼                   ▼                   ▼
         ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
         │  智核工作台     │  │  移动端App      │  │  浏览器插件     │
         │ (前台触点)      │  │                │  │                │
         └────────┬───────┘  └────────┬───────┘  └────────┬───────┘
                  │                   │                   │
                  └───────────────────┼───────────────────┘
                                      │
                         ┌────────────▼────────────┐
                         │                         │
                         │   AgentOS 智能中枢      │
                         │                         │
                         │  ┌──────────────────┐  │
                         │  │  01-灵枢（后台） │  │
                         │  │  企业认知基座     │  │
                         │  └──────────────────┘  │
                         │  ┌──────────────────┐  │
                         │  │  02-无影（中台） │  │
                         │  │  集成赋能层       │  │
                         │  └──────────────────┘  │
                         │  ┌──────────────────┐  │
                         │  │  03-智核（前台） │  │
                         │  │  智能工作台       │  │
                         │  └──────────────────┘  │
                         │                         │
                         └────────────┬────────────┘
                                      │
                  ┌───────────────────┼───────────────────┐
                  │                   │                   │
                  ▼                   ▼                   ▼
         ┌────────────────┐  ┌────────────────┐  ┌────────────────┐
         │  外部系统       │  │  大模型服务     │  │  企业IT系统     │
         │ (飞书/钉钉)     │  │ (OpenAI/Claude) │  │ (CRM/ERP/Git)  │
         └────────────────┘  └────────────────┘  └────────────────┘
```

**外部依赖**：
- **协同办公平台**：飞书、钉钉、企业微信（通过无影连接器对接）
- **大模型服务**：OpenAI API、Claude API、国产大模型（Azure/阿里云）
- **企业IT系统**：CRM（Salesforce）、ERP（SAP）、代码仓库（GitLab）、文档系统（Confluence）

### 2.2 Container视图：容器架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           AgentOS 平台                                   │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    前台层：智核工作台（03-智核）                    │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ Web前端    │  │ 搜索服务   │  │ 协作服务   │  │ 个人中心   │ │  │
│  │  │ (React)    │  │            │  │            │  │            │ │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                   ▲                                     │
│                                   │ HTTPS/gRPC                          │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    中台层：无影集成赋能（02-无影）                  │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ API网关    │  │ 连接器框架 │  │ 事件总线   │  │ 数据同步   │ │  │
│  │  │ (Kong/APISIX)│ │ (50+连接器)│ │ (Kafka)    │  │ 引擎       │ │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                   ▲                                     │
│                                   │ REST/gRPC                           │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    后台层：灵枢智能中枢（01-灵枢）                  │  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐│  │
│  │  │              设计态：本体论工厂                               ││  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                   ││  │
│  │  │  │本体建模  │  │语义映射  │  │冲突仲裁  │                   ││  │
│  │  │  └──────────┘  └──────────┘  └──────────┘                   ││  │
│  │  └──────────────────────────────────────────────────────────────┘│  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐│  │
│  │  │              加工态：知识熔炉                                 ││  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││  │
│  │  │  │数据接入  │  │智能萃取  │  │质量校验  │  │融合去重  │    ││  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││  │
│  │  └──────────────────────────────────────────────────────────────┘│  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐│  │
│  │  │              存储态：动态知识图谱                             ││  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││  │
│  │  │  │图谱存储  │  │向量存储  │  │混合检索  │  │推理引擎  │    ││  │
│  │  │  │(Neo4j)   │  │(Milvus)  │  │          │  │          │    ││  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││  │
│  │  └──────────────────────────────────────────────────────────────┘│  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐│  │
│  │  │              智能体核心：智能体工厂                           ││  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││  │
│  │  │  │智能体编排│  │运行容器  │  │技能市场  │  │思维链追踪│    ││  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││  │
│  │  └──────────────────────────────────────────────────────────────┘│  │
│  │                                                                    │  │
│  │  ┌──────────────────────────────────────────────────────────────┐│  │
│  │  │              治理态:进化与治理中心                            ││  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││  │
│  │  │  │健康监控  │  │进化提案  │  │审计追溯  │  │权限管理  │    ││  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││  │
│  │  └──────────────────────────────────────────────────────────────┘│  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                         基础设施层                                │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ 消息队列   │  │ 缓存       │  │ 对象存储   │  │ 日志分析   │ │  │
│  │  │ (Kafka)    │  │ (Redis)    │  │ (MinIO/S3) │  │ (ELK Stack)│ │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │  │
│  │  │ 监控告警   │  │ 服务网格   │  │ 配置中心   │  │ 调度编排   │ │  │
│  │  │(Prometheus)│  │ (Istio)    │  │ (Consul)   │  │(Kubernetes)│ │  │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Component视图：核心组件

#### 2.3.1 灵枢核心组件

**本体论工厂服务组**：
```
┌─────────────────────────────────────────────────────────────┐
│                      本体论工厂                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │ 本体建模引擎  │  │ 语义映射引擎  │  │ 冲突检测引擎  │  │
│  │ - 实体定义    │  │ - 映射配置    │  │ - 规则检查    │  │
│  │ - 关系建模    │  │ - 转换函数    │  │ - 异常报告    │  │
│  │ - 规则绑定    │  │ - 映射测试    │  │ - 仲裁流程    │  │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  │
│          │                  │                  │          │
│          └──────────────────┼──────────────────┘          │
│                             ▼                             │
│                   ┌───────────────────┐                   │
│                   │  本体存储         │                   │
│                   │  (PostgreSQL)     │                   │
│                   │  - 实体表         │                   │
│                   │  - 关系表         │                   │
│                   │  - 规则表         │                   │
│                   │  - 版本历史       │                   │
│                   └───────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

**知识熔炉服务组**：
```
┌─────────────────────────────────────────────────────────────┐
│                      知识熔炉                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              数据接入层                             │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │DB连接器  │  │API连接器 │  │文件监听  │  ...     │   │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘          │   │
│  │       └──────────────┼──────────────┘               │   │
│  └──────────────────────┼──────────────────────────────┘   │
│                         ▼                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              加工流水线引擎                         │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │NLP萃取   │→ │向量化    │→ │质量校验  │→ 输出    │   │
│  │  │(NER/分类)│  │(嵌入模型)│  │(规则检查)│          │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ▼                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              融合与去重引擎                         │   │
│  │  • 跨源融合策略（优先级/时间衰减/投票）            │   │
│  │  • 实体消歧（同名异物/同物异名）                   │   │
│  │  • 冲突解决（人工仲裁队列）                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**动态知识图谱服务组**：
```
┌─────────────────────────────────────────────────────────────┐
│                    动态知识图谱                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │ 图谱存储引擎  │  │ 向量存储引擎  │  │ 关系型存储    │  │
│  │ (Neo4j)       │  │ (Milvus)      │  │ (PostgreSQL)  │  │
│  │ - 三元组存储  │  │ - 嵌入向量    │  │ - 元数据      │  │
│  │ - 属性图      │  │ - 索引(IVF)   │  │ - 配置信息    │  │
│  │ - Cypher查询  │  │ - 相似度检索  │  │               │  │
│  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘  │
│          │                  │                  │          │
│          └──────────────────┼──────────────────┘          │
│                             ▼                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              混合检索引擎                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │  │
│  │  │全文检索  │  │语义检索  │  │图谱遍历  │          │  │
│  │  │(ES)      │  │(向量相似)│  │(路径查询)│          │  │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘          │  │
│  │       └──────────────┼──────────────┘               │  │
│  │                      ▼                               │  │
│  │          ┌───────────────────────┐                  │  │
│  │          │  结果融合与排序       │                  │  │
│  │          │  (BM25 + 语义 + 图谱) │                  │  │
│  │          └───────────────────────┘                  │  │
│  └─────────────────────────────────────────────────────┘  │
│                             ▼                             │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              推理与洞察引擎                         │  │
│  │  • 规则推理（Rete算法）                            │  │
│  │  • 路径发现（最短路径/关键路径）                   │  │
│  │  • 社区检测（Louvain算法）                         │  │
│  │  • 影响力分析（PageRank变种）                      │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3.2 无影核心组件

**连接器框架**：
```
┌─────────────────────────────────────────────────────────────┐
│                      连接器框架                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │          连接器生命周期管理                         │   │
│  │  注册 → 配置 → 部署 → 监控 → 升级 → 下线          │   │
│  └─────────────────────────────────────────────────────┘   │
│                             ▼                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │          预置连接器库（50+）                        │   │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐          │   │
│  │  │飞书连接器│  │钉钉连接器│  │GitLab    │  ...     │   │
│  │  └──────────┘  └──────────┘  └──────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
│                             ▼                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │          连接器开发SDK                              │   │
│  │  • 接口规约（数据读取/写入/事件订阅）              │   │
│  │  • 公共库（认证/限流/重试/日志）                   │   │
│  │  • 测试框架（单元/集成测试）                       │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

**API网关**：
```
┌─────────────────────────────────────────────────────────────┐
│                      API网关 (Kong/APISIX)                  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │ 路由管理      │  │ 认证鉴权      │  │ 限流熔断      │  │
│  │ - 路径匹配    │  │ - JWT验证     │  │ - Token Bucket│  │
│  │ - 负载均衡    │  │ - OAuth2      │  │ - 熔断降级    │  │
│  │ - 版本控制    │  │ - RBAC检查    │  │ - 流量整形    │  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  │
│  │ 协议转换      │  │ 监控统计      │  │ 日志审计      │  │
│  │ - REST→gRPC   │  │ - QPS/延迟    │  │ - 访问日志    │  │
│  │ - GraphQL     │  │ - 错误率      │  │ - 操作审计    │  │
│  └───────────────┘  └───────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、技术选型决策

### 3.1 核心技术栈对比

#### 3.1.1 图数据库选型

| 数据库 | 优势 | 劣势 | 评分 | 决策 |
|--------|------|------|------|------|
| **Neo4j** | • 成熟度高，生态完善<br>• Cypher语言易学<br>• 可视化工具强大<br>• 企业版支持分片 | • 企业版收费较高<br>• 单机版有节点数限制 | ⭐⭐⭐⭐⭐ | **✅ 推荐** |
| JanusGraph | • 完全开源免费<br>• 支持多种后端存储<br>• 水平扩展能力强 | • 社区活跃度低<br>• 运维复杂<br>• 文档不够完善 | ⭐⭐⭐ | 备选 |
| Nebula Graph | • 国产开源<br>• 高性能（C++实现）<br>• 支持分布式 | • 生态相对弱<br>• 企业案例少 | ⭐⭐⭐⭐ | 备选 |

**最终决策**：**Neo4j Enterprise**
- **理由**：生态成熟、工具完善、学习曲线平缓，适合快速落地
- **成本估算**：企业版约$3-5K/节点/年（私有化）或按QPS计费（云端）
- **备选方案**：如客户预算受限，可用Neo4j Community Edition + 自研分片层

#### 3.1.2 向量数据库选型

| 数据库 | 优势 | 劣势 | 评分 | 决策 |
|--------|------|------|------|------|
| **Milvus** | • 开源免费<br>• 性能优秀（C++内核）<br>• 支持多种索引（IVF/HNSW）<br>• 云原生架构 | • 运维复杂度中等<br>• 社区文档英文为主 | ⭐⭐⭐⭐⭐ | **✅ 推荐** |
| Weaviate | • 开箱即用<br>• 集成大模型API<br>• GraphQL接口友好 | • 性能略逊于Milvus<br>• 企业版收费 | ⭐⭐⭐⭐ | 备选 |
| Pinecone | • 完全托管SaaS<br>• 运维成本低 | • 仅云端服务<br>• 不支持私有化<br>• 费用较高 | ⭐⭐⭐ | 不适用 |

**最终决策**：**Milvus**
- **理由**：开源、高性能、支持私有化，与我们产品定位匹配
- **部署方案**：使用Milvus Operator在K8s上部署
- **向量维度**：默认768维（BERT-base），可配置1536维（OpenAI Embedding）

#### 3.1.3 编程语言与框架

| 技术领域 | 选型 | 理由 |
|---------|------|------|
| **后端服务** | Python 3.11 + FastAPI | • AI/NLP生态最完善<br>• 快速开发，适合算法迭代<br>• FastAPI异步性能优秀 |
| **高性能API** | Go 1.21 | • 并发性能强<br>• 用于API网关、数据同步等高吞吐场景 |
| **前端** | React 18 + TypeScript | • 生态成熟<br>• TypeScript提升可维护性 |
| **流处理** | Python + Apache Flink | • Flink适合实时数据处理<br>• PyFlink支持Python开发 |

**核心依赖库**：
- **Python**：
  - Web框架：FastAPI 0.104+
  - 图谱操作：neo4j-driver, py2neo
  - 向量操作：pymilvus
  - NLP：transformers, spacy, jieba
  - 任务调度：Celery + Redis
- **Go**：
  - Web框架：Gin
  - 微服务：go-micro
  - gRPC：grpc-go

#### 3.1.4 基础设施组件

| 组件类型 | 选型 | 版本 | 说明 |
|---------|------|------|------|
| **消息队列** | Apache Kafka | 3.6+ | 事件驱动架构核心，高吞吐 |
| **缓存** | Redis | 7.2+ | 热点数据缓存、分布式锁 |
| **对象存储** | MinIO（私有化）/ S3（云端） | - | 文档、多媒体文件存储 |
| **关系型数据库** | PostgreSQL | 16+ | 用户/权限/配置/日志 |
| **全文检索** | Elasticsearch | 8.11+ | 辅助知识检索，与向量检索互补 |
| **容器编排** | Kubernetes | 1.28+ | 容器化部署标准 |
| **服务网格** | Istio | 1.20+ | 服务间通信、流量管理 |
| **监控告警** | Prometheus + Grafana | - | 指标监控、可视化 |
| **链路追踪** | Jaeger | - | 分布式链路追踪 |
| **日志分析** | ELK Stack | - | 日志聚合与分析 |

---

## 四、部署架构设计

### 4.1 私有化部署架构（推荐配置）

#### 4.1.1 小型部署（1000用户以内）

```
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              应用层 (6个节点)                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │智核前端 │  │无影中台 │  │灵枢后台 │  (各2副本) │   │
│  │  └─────────┘  └─────────┘  └─────────┘             │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              数据层 (4个节点)                       │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │Neo4j集群│  │Milvus   │  │PostgreSQL│            │   │
│  │  │(3节点)  │  │         │  │          │            │   │
│  │  └─────────┘  └─────────┘  └─────────┘             │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              基础设施层 (3个节点)                   │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │Kafka    │  │Redis    │  │MinIO    │             │   │
│  │  └─────────┘  └─────────┘  └─────────┘             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

硬件需求：
- 应用层：6台服务器，每台16C/64GB/500GB SSD
- 数据层：4台服务器，每台32C/128GB/2TB SSD（Neo4j需要高IOPS）
- 基础设施层：3台服务器，每台16C/64GB/1TB SSD
- 网络：万兆网卡，建议使用独立存储网络
- 总计：13台物理服务器
```

#### 4.1.2 中大型部署（10000用户以内）

```
┌─────────────────────────────────────────────────────────────┐
│            Kubernetes Cluster (Multi-AZ)                    │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              应用层 (20个节点)                      │   │
│  │  智核前端 (6副本) + 无影中台 (6副本) + 灵枢后台(8副本)│   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              数据层 (12个节点)                      │   │
│  │  Neo4j集群(6节点,分片) + Milvus(4节点) + PG(2节点HA)│   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              基础设施层 (8个节点)                   │   │
│  │  Kafka(3) + Redis(3,哨兵) + MinIO(2,HA)             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘

硬件需求：
- 应用层：20台，每台32C/128GB/1TB SSD
- 数据层：12台，每台64C/256GB/4TB NVMe SSD
- 基础设施层：8台，每台32C/128GB/2TB SSD
- 网络：万兆或更高，使用RDMA提升性能
- 总计：40台物理服务器
```

### 4.2 云端SaaS部署架构

#### 4.2.1 多租户隔离方案

```
┌─────────────────────────────────────────────────────────────┐
│                    租户隔离架构                             │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              租户路由层                             │   │
│  │  根据JWT中的tenant_id路由到对应租户实例            │   │
│  └────────────────────┬────────────────────────────────┘   │
│                       │                                     │
│       ┌───────────────┼───────────────┐                    │
│       │               │               │                    │
│       ▼               ▼               ▼                    │
│  ┌─────────┐     ┌─────────┐     ┌─────────┐             │
│  │ 租户A   │     │ 租户B   │     │ 租户C   │  ...         │
│  │ ┌─────┐ │     │ ┌─────┐ │     │ ┌─────┐ │             │
│  │ │应用 │ │     │ │应用 │ │     │ │应用 │ │             │
│  │ └──┬──┘ │     │ └──┬──┘ │     │ └──┬──┘ │             │
│  │    │    │     │    │    │     │    │    │             │
│  │ ┌──▼──┐ │     │ ┌──▼──┐ │     │ ┌──▼──┐ │             │
│  │ │数据 │ │     │ │数据 │ │     │ │数据 │ │             │
│  │ │库   │ │     │ │库   │ │     │ │库   │ │             │
│  │ └─────┘ │     │ └─────┘ │     │ └─────┘ │             │
│  └─────────┘     └─────────┘     └─────────┘             │
│                                                              │
│  数据隔离策略：                                              │
│  • Schema隔离：不同租户使用独立Database Schema             │
│  • 图谱隔离：Neo4j中使用tenant_id属性标记所有节点/边       │
│  • 向量隔离：Milvus中使用独立Collection                    │
│  • 对象存储隔离：MinIO中使用独立Bucket                     │
└─────────────────────────────────────────────────────────────┘
```

#### 4.2.2 弹性伸缩策略

| 资源类型 | 触发条件 | 伸缩动作 | 冷却时间 |
|---------|---------|---------|---------|
| **应用Pod** | CPU > 70% 持续5分钟 | 增加2个副本（最多20副本） | 3分钟 |
| **应用Pod** | CPU < 30% 持续10分钟 | 减少2个副本（最少4副本） | 5分钟 |
| **Neo4j节点** | 查询延迟P95 > 1s | 增加1个读副本 | 15分钟 |
| **Milvus节点** | QPS > 10000 | 增加1个Query Node | 10分钟 |

---

## 五、数据流设计

### 5.1 知识加工全流程

```
┌──────────┐
│ 外部数据 │  (Confluence/GitLab/飞书文档/CRM数据)
└─────┬────┘
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│         1. 数据接入层 (无影连接器)                      │
│  • 连接器拉取数据                                       │
│  • 增量/全量同步控制                                    │
│  • 数据格式标准化                                       │
└─────┬───────────────────────────────────────────────────┘
      │ Kafka Topic: raw_data_stream
      ▼
┌─────────────────────────────────────────────────────────┐
│         2. 知识萃取层 (灵枢-知识熔炉)                   │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │文本清洗 │→ │NLP萃取  │→ │向量化   │→ │实体链接 │   │
│  │去噪/分段│  │NER/分类 │  │Embedding│  │消歧     │   │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
└─────┬───────────────────────────────────────────────────┘
      │ Kafka Topic: processed_knowledge
      ▼
┌─────────────────────────────────────────────────────────┐
│         3. 质量校验层 (灵枢-质量网关)                   │
│  • 完整性检查（必填字段）                               │
│  • 一致性检查（与本体冲突检测）                         │
│  • 时效性检查（是否过期）                               │
│  • 合格 → 存储；不合格 → 人工审核队列                  │
└─────┬───────────────────────────────────────────────────┘
      │ Kafka Topic: validated_knowledge
      ▼
┌─────────────────────────────────────────────────────────┐
│         4. 存储层 (灵枢-动态知识图谱)                   │
│  • Neo4j：写入三元组（实体-关系-实体）                 │
│  • Milvus：写入向量（知识ID → 嵌入向量）               │
│  • PostgreSQL：写入元数据（来源/创建时间/版本）        │
└─────┬───────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│         5. 索引层                                        │
│  • Neo4j自动索引更新                                    │
│  • Milvus索引重建（IVF/HNSW）                          │
│  • Redis缓存热点数据                                    │
└─────┬───────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│         6. 服务层（对外提供API）                        │
│  • 智核前端调用检索API                                  │
│  • 智能体调用推理API                                    │
│  • 外部系统调用开放API                                  │
└─────────────────────────────────────────────────────────┘
```

### 5.2 用户查询流程

```
用户输入查询 → 智核前端
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│         1. 查询预处理 (智核)                            │
│  • 查询意图识别（搜索/问答/分析）                       │
│  • 查询改写与扩展                                       │
│  • 权限预检查（用户可访问范围）                         │
└─────┬───────────────────────────────────────────────────┘
      │ gRPC调用
      ▼
┌─────────────────────────────────────────────────────────┐
│         2. 混合检索 (灵枢-知识图谱)                     │
│  并行执行三路检索：                                      │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                 │
│  │全文检索 │  │语义检索 │  │图谱遍历 │                 │
│  │(ES BM25)│  │(Milvus) │  │(Neo4j)  │                 │
│  └────┬────┘  └────┬────┘  └────┬────┘                 │
│       └────────────┼────────────┘                       │
└────────────────────┼──────────────────────────────────┘
                     ▼
┌─────────────────────────────────────────────────────────┐
│         3. 结果融合与排序                               │
│  • 计算综合得分（BM25 × 0.3 + 语义相似度 × 0.4 +       │
│                  图谱关联度 × 0.3）                     │
│  • 权限过滤（根据用户角色过滤敏感内容）                 │
│  • 多样性优化（避免结果过于相似）                       │
└─────┬───────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│         4. 结果增强 (可选)                              │
│  • 调用大模型生成摘要/答案                              │
│  • 关联推荐（相关知识/相关专家）                        │
│  • 溯源标注（知识来源/可信度）                          │
└─────┬───────────────────────────────────────────────────┘
      │
      ▼
返回前端展示
```

---

## 六、非功能设计

### 6.1 性能优化策略

#### 6.1.1 查询性能优化

| 优化措施 | 技术方案 | 预期效果 |
|---------|---------|---------|
| **多级缓存** | • L1：进程内缓存（本地LRU）<br>• L2：Redis集群<br>• L3：CDN（静态资源） | API响应时间 < 50ms（缓存命中） |
| **索引优化** | • Neo4j：为常用属性建立索引<br>• Milvus：使用HNSW索引（精度vs速度权衡）<br>• ES：优化mapping和分词器 | 查询延迟 P95 < 200ms |
| **异步处理** | • 重计算任务进入Celery队列<br>• 结果通过WebSocket推送 | 用户无阻塞等待 |
| **批处理** | • 批量插入/更新（每批1000条）<br>• 批量向量化（避免频繁调用模型） | 吞吐量提升10倍 |
| **连接池** | • 数据库连接池（每服务最多50连接）<br>• HTTP连接池（复用TCP连接） | 减少连接开销 |

#### 6.1.2 存储性能优化

| 存储系统 | 优化措施 | 预期性能 |
|---------|---------|---------|
| **Neo4j** | • 使用SSD/NVMe存储<br>• 配置足够的Page Cache（建议50%内存）<br>• 读写分离（主从复制） | 单节点QPS > 10000<br>写入TPS > 5000 |
| **Milvus** | • 使用HNSW索引（nlist=16384, m=16）<br>• 数据预加载到内存<br>• GPU加速向量计算（可选） | 百万向量检索 < 10ms<br>QPS > 10000 |
| **PostgreSQL** | • 分区表（按时间/租户分区）<br>• 物化视图（预计算常用统计）<br>• 读写分离 | QPS > 20000 |

### 6.2 高可用设计

#### 6.2.1 服务可用性

| 组件 | HA方案 | RTO | RPO |
|------|--------|-----|-----|
| **应用服务** | K8s多副本 + 健康检查 + 自动重启 | < 1分钟 | 0（无状态） |
| **Neo4j** | 主从复制（1主2从）+ 自动故障切换 | < 5分钟 | < 30秒 |
| **Milvus** | 存算分离 + MinIO高可用存储 | < 3分钟 | 0 |
| **PostgreSQL** | 主从流复制 + Patroni自动切换 | < 2分钟 | < 10秒 |
| **Kafka** | 3副本 + ISR机制 | < 1分钟 | 0 |
| **Redis** | 哨兵模式（1主2从3哨兵） | < 30秒 | < 1秒 |

#### 6.2.2 容灾方案

**同城双活**（推荐）：
- 两个数据中心（相距20-100公里）
- 数据实时双写或异步复制
- 任一中心故障，流量自动切换
- RTO < 10分钟，RPO < 5分钟

**异地灾备**（高标准）：
- 生产中心 + 异地灾备中心（相距>200公里）
- 定期全量备份 + 增量日志同步
- 灾备中心定期演练
- RTO < 2小时，RPO < 30分钟

### 6.3 安全设计

#### 6.3.1 认证与授权

```
┌─────────────────────────────────────────────────────────┐
│                    认证流程                             │
│  用户登录 → 统一认证中心 (OAuth2/SAML)                 │
│          ← JWT Token (包含user_id, tenant_id, roles)    │
│                                                          │
│  用户请求 → API网关 → JWT验证 → RBAC权限检查 → 后端服务│
└─────────────────────────────────────────────────────────┘
```

**权限模型**：RBAC + ABAC
- **RBAC（基于角色）**：
  - 超级管理员：全部权限
  - 本体管理员：管理本体定义、映射规则
  - 知识管理员：审核知识、配置流水线
  - 普通用户：查询知识、使用智能体
- **ABAC（基于属性）**：
  - 根据知识属性（敏感级别/部门/项目）动态控制访问
  - 示例：`IF 用户.部门 == 知识.所属部门 OR 用户.角色 == "管理员" THEN 允许访问`

#### 6.3.2 数据安全

| 安全措施 | 技术方案 |
|---------|---------|
| **传输加密** | • HTTPS（TLS 1.3）<br>• gRPC over TLS<br>• 数据库连接SSL |
| **存储加密** | • 敏感字段加密（AES-256）<br>• 数据库透明加密（TDE）<br>• 对象存储加密（S3 SSE） |
| **数据脱敏** | • 敏感词自动检测与打码<br>• 日志脱敏（手机号/身份证/邮箱） |
| **审计日志** | • 所有操作记录到审计库<br>• 敏感操作（权限变更/数据导出）实时告警 |

#### 6.3.3 安全合规

| 合规标准 | 实施措施 |
|---------|---------|
| **等保三级** | • 完成定级备案<br>• 实施安全加固<br>• 通过等保测评 |
| **GDPR** | • 数据跨境合规审查<br>• 用户数据删除机制<br>• 隐私政策完善 |
| **SOC2** | • 实施安全控制措施<br>• 第三方审计 |

---

## 七、关键技术难点与应对

### 7.1 难点1：万亿级图谱的存储与查询

**问题**：单机Neo4j无法支撑万亿级节点（实际目标：10亿级）

**解决方案**：
1. **图谱分片**：
   - 按租户分片（不同租户的图谱存储在不同Neo4j实例）
   - 按领域分片（如"人事图谱"、"项目图谱"分开存储）
2. **冷热分离**：
   - 热数据（近3个月）：Neo4j内存
   - 温数据（3-12个月）：Neo4j磁盘
   - 冷数据（12个月以上）：归档到对象存储，需要时加载
3. **图谱压缩**：
   - 去除冗余关系（如自动推理出的传递关系）
   - 合并同类节点（如多个"张三"合并为一个）

**性能目标**：
- 单图谱规模：10亿节点 + 100亿边
- 查询延迟：2跳查询 < 100ms，3跳查询 < 500ms
- 吞吐量：单集群QPS > 50000

### 7.2 难点2：实时性与一致性的权衡

**问题**：知识更新后，图谱/向量/缓存/索引的同步延迟

**解决方案**：
1. **最终一致性**（推荐）：
   - 写入流程：数据 → Kafka → 异步消费 → 更新存储
   - 延迟：P95 < 3秒
   - 适用场景：绝大多数知识管理场景
2. **强一致性**（按需）：
   - 关键数据（如权限变更）使用同步写入
   - 采用两阶段提交（2PC）
   - 延迟：P95 < 500ms
3. **缓存失效策略**：
   - Write-through：写入时同步更新缓存
   - Write-behind：异步更新缓存（容忍短暂不一致）
   - 关键数据使用Write-through，普通数据使用Write-behind

### 7.3 难点3：多租户隔离的性能开销

**问题**：每次查询需检查tenant_id，增加查询复杂度

**解决方案**：
1. **数据库层隔离**：
   - 不同租户使用独立Database Schema（推荐中小租户）
   - 大租户使用独立集群
2. **索引优化**：
   - Neo4j：为tenant_id建立复合索引
   - Milvus：使用Partition按租户隔离
3. **缓存预热**：
   - 租户登录时，预加载其权限和常用数据到缓存

---

## 八、技术债务管理

### 8.1 已知技术债务

| 债务 | 影响 | 偿还计划 |
|------|------|---------|
| **V1.0使用单机Neo4j** | 无法支撑超大规模图谱 | V2.0实施分片方案 |
| **缺少图谱Schema验证** | 数据质量风险 | Q2补充Schema Validation |
| **日志未结构化** | 难以分析 | Q2统一使用JSON格式日志 |
| **缺少混沌测试** | 故障恢复能力未验证 | Q3引入Chaos Mesh |

### 8.2 技术选型备选方案

| 组件 | 当前方案 | 备选方案 | 切换条件 |
|------|---------|---------|---------|
| 图数据库 | Neo4j | JanusGraph | 客户预算受限或需超大规模 |
| 向量数据库 | Milvus | Weaviate | 需要开箱即用、运维简化 |
| 消息队列 | Kafka | RabbitMQ | 消息量不大、需要简单部署 |
| 服务网格 | Istio | Linkerd | 运维复杂度过高 |

---

## 九、开发规范与约束

### 9.1 微服务拆分原则

**拆分粒度**：
- ✅ **按业务领域拆分**：本体管理服务、知识萃取服务、图谱查询服务
- ✅ **按读写分离**：查询服务（只读）、写入服务（写入）
- ❌ 不要过度拆分：避免一个简单功能拆成多个微服务

**服务间通信**：
- **同步调用**：gRPC（内部）、REST（外部）
- **异步调用**：Kafka事件

### 9.2 API设计规范

**RESTful API规范**：
```
GET    /api/v1/knowledge/{id}          # 获取单个知识
GET    /api/v1/knowledge?q=xxx&limit=10 # 查询知识列表
POST   /api/v1/knowledge               # 创建知识
PUT    /api/v1/knowledge/{id}          # 更新知识（全量）
PATCH  /api/v1/knowledge/{id}          # 更新知识（部分）
DELETE /api/v1/knowledge/{id}          # 删除知识
```

**错误码规范**：
- 2xx：成功
- 4xx：客户端错误（400参数错误、401未认证、403无权限、404不存在）
- 5xx：服务端错误（500内部错误、503服务不可用）

详细规范见：[05-API接口设计规范.md](./05-API接口设计规范.md)（待补充）

---

## 十、路线图与演进计划

### 10.1 V1.0（MVP，Q1-Q2 2026）

**目标**：验证核心能力，支持单租户私有化部署

| 功能模块 | 实现范围 |
|---------|---------|
| 灵枢 | • 本体建模（基础版）<br>• 单源接入（Confluence/GitLab）<br>• 基础NLP萃取<br>• Neo4j单机版图谱<br>• 混合检索（BM25+语义） |
| 无影 | • 10个预置连接器<br>• 基础API网关 |
| 智核 | • 统一搜索入口<br>• 简单协作空间 |

**非功能需求**：
- 支持1000用户
- 图谱规模：1亿节点
- API响应：P95 < 300ms

### 10.2 V2.0（规模化，Q3-Q4 2026）

**目标**：支持大规模图谱、多租户SaaS

| 功能模块 | 升级内容 |
|---------|---------|
| 灵枢 | • Neo4j分片集群<br>• 智能体工厂<br>• 进化提案引擎 |
| 无影 | • 50+连接器<br>• 低代码连接器开发平台 |
| 智核 | • 个性化推荐<br>• 智能协作（智能体协同） |

**非功能需求**：
- 支持10000用户
- 图谱规模：10亿节点
- API响应：P95 < 200ms
- 多租户SaaS模式

### 10.3 V3.0（智能化，2027）

**目标**：自进化系统、行业知识大模型

- 知识大模型微调（基于企业数据）
- 自动化本体构建
- 智能体自主学习与优化
- 跨企业知识联邦

---

## 十一、附录

### 11.1 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 本体 | Ontology | 概念体系，定义实体、关系、属性 |
| 三元组 | Triple | (主语, 谓语, 宾语)，知识图谱的基本单元 |
| 向量嵌入 | Embedding | 将文本转换为高维向量表示 |
| 语义检索 | Semantic Search | 基于语义相似度的检索 |
| 混合检索 | Hybrid Search | 结合关键词、语义、图谱的检索 |
| 图谱遍历 | Graph Traversal | 沿着边在图中移动，查找路径 |
| 实体消歧 | Entity Disambiguation | 区分同名但不同义的实体 |

### 11.2 参考资料

- [Neo4j Operations Manual](https://neo4j.com/docs/operations-manual/)
- [Milvus Documentation](https://milvus.io/docs)
- [Kubernetes Best Practices](https://kubernetes.io/docs/concepts/)
- [Istio Architecture](https://istio.io/latest/docs/ops/deployment/architecture/)

### 11.3 关键决策记录（ADR）

| ADR编号 | 决策 | 日期 | 理由 |
|---------|------|------|------|
| ADR-001 | 选用Neo4j而非JanusGraph | 2026-01-08 | 生态成熟、学习曲线平缓、适合快速落地 |
| ADR-002 | 选用Milvus而非Pinecone | 2026-01-08 | 支持私有化部署、开源免费 |
| ADR-003 | 采用最终一致性而非强一致性 | 2026-01-08 | 知识管理场景容忍3秒延迟，性能优先 |

---

**文档状态**：✅ V1.0完成（2026-01-08）
**下一步行动**：
1. 技术选型决策评审（需决策层确认预算）
2. 补充《04-数据模型与Schema设计.md》
3. 补充《05-API接口设计规范.md》
4. 启动POC验证（Neo4j + Milvus性能测试）

---

**最后更新时间**：2026-01-08
**负责人**：技术架构组
**审核人**：待定
